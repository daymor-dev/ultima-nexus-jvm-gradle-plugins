name: Publish Plugins

permissions:
  contents: read

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      subproject:
        description: 'Subproject to publish (leave empty for all with version changes)'
        required: false
        default: ''
      force:
        description: 'Force publish even if version unchanged'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  discover:
    name: Discover Modules
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Discover plugin modules
        id: discover
        run: |
          modules=$(ls -d plugins-*/ 2>/dev/null | sed 's/\///' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix={\"subproject\":$modules}" >> $GITHUB_OUTPUT
          echo "Discovered modules: $modules"

  build:
    name: Build and Validate
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build and Validate All
        run: ./gradlew buildAll validateAll --parallel

      - name: Upload test reports
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: test-reports-all
          path: '**/build/reports/tests/'
          retention-days: 7

  publish:
    name: Publish ${{ matrix.subproject }}
    needs: [discover, build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check if should publish
        id: check
        run: |
          SUBPROJECT="${{ matrix.subproject }}"
          INPUT_SUBPROJECT="${{ github.event.inputs.subproject }}"
          FORCE="${{ github.event.inputs.force }}"

          # Check if this module was explicitly requested
          if [ -n "$INPUT_SUBPROJECT" ] && [ "$INPUT_SUBPROJECT" != "$SUBPROJECT" ]; then
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "Skipping $SUBPROJECT (not requested)"
            exit 0
          fi

          # Get local version from gradle.properties
          LOCAL_VERSION=$(grep "^version" "$SUBPROJECT/gradle.properties" | cut -d'=' -f2 | tr -d ' ')
          echo "Local version: $LOCAL_VERSION"

          # Get group ID from shared properties
          GROUP_ID=$(grep "^groupId" "gradle/shared.properties" | cut -d'=' -f2 | tr -d ' ')

          # Query Gradle Plugin Portal for published version
          # Check if artifact exists in Maven repo (returns 200 if exists, 404 if not)
          HTTP_STATUS=$(curl -s "https://plugins.gradle.org/m2/${GROUP_ID//.//}/${SUBPROJECT}/${LOCAL_VERSION}/${SUBPROJECT}-${LOCAL_VERSION}.pom" -o /dev/null -w "%{http_code}")

          if [ "$HTTP_STATUS" = "200" ] && [ "$FORCE" != "true" ]; then
            echo "Version $LOCAL_VERSION already published for $SUBPROJECT"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Version $LOCAL_VERSION needs publishing for $SUBPROJECT"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 25
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        if: steps.check.outputs.should_publish == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Publish to Gradle Plugin Portal
        if: steps.check.outputs.should_publish == 'true'
        run: |
          cd ${{ matrix.subproject }}
          ../gradlew publishPlugins
        env:
          GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
