name: Dependabot Auto-merge

on: pull_request

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-and-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync fallback versions
        run: |
          # Parse versions from libs.versions.toml
          TOML_FILE="gradle/libs.versions.toml"
          KOTLIN_FILE="plugins-core/src/main/kotlin/dev/daymor/ultimanexus/jvm/gradle/util/DependencyUtils.kt"

          # Extract versions from TOML
          get_version() {
            grep "^$1 = " "$TOML_FILE" | sed 's/.*= "\(.*\)"/\1/'
          }

          ASSERTJ=$(get_version "assertj")
          BYTE_BUDDY=$(get_version "byte-buddy-agent")
          CHECKSTYLE=$(get_version "checkstyle")
          JSPECIFY=$(get_version "jspecify")
          JSR305=$(get_version "jsr305")
          JUNIT=$(get_version "junit-jupiter")
          LOMBOK=$(get_version "lombok")
          MOCKK=$(get_version "mockk")
          PMD=$(get_version "pmd")
          SLF4J=$(get_version "slf4j")
          SPRING_BOOT=$(get_version "spring-boot-dependencies")

          # Update DependencyUtils.kt with new versions
          sed -i "s/const val ASSERTJ = \"[^\"]*\"/const val ASSERTJ = \"$ASSERTJ\"/" "$KOTLIN_FILE"
          sed -i "s/const val BYTE_BUDDY_AGENT = \"[^\"]*\"/const val BYTE_BUDDY_AGENT = \"$BYTE_BUDDY\"/" "$KOTLIN_FILE"
          sed -i "s/const val CHECKSTYLE = \"[^\"]*\"/const val CHECKSTYLE = \"$CHECKSTYLE\"/" "$KOTLIN_FILE"
          sed -i "s/const val JSPECIFY = \"[^\"]*\"/const val JSPECIFY = \"$JSPECIFY\"/" "$KOTLIN_FILE"
          sed -i "s/const val JSR305 = \"[^\"]*\"/const val JSR305 = \"$JSR305\"/" "$KOTLIN_FILE"
          sed -i "s/const val JUNIT_JUPITER = \"[^\"]*\"/const val JUNIT_JUPITER = \"$JUNIT\"/" "$KOTLIN_FILE"
          sed -i "s/const val LOMBOK = \"[^\"]*\"/const val LOMBOK = \"$LOMBOK\"/" "$KOTLIN_FILE"
          sed -i "s/const val MOCKK = \"[^\"]*\"/const val MOCKK = \"$MOCKK\"/" "$KOTLIN_FILE"
          sed -i "s/const val PMD = \"[^\"]*\"/const val PMD = \"$PMD\"/" "$KOTLIN_FILE"
          sed -i "s/const val SLF4J = \"[^\"]*\"/const val SLF4J = \"$SLF4J\"/" "$KOTLIN_FILE"
          sed -i "s/const val SPRING_BOOT = \"[^\"]*\"/const val SPRING_BOOT = \"$SPRING_BOOT\"/" "$KOTLIN_FILE"

      - name: Commit changes if any
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync fallback versions with libs.versions.toml"
            git push
          fi

      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch and minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
